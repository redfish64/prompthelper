<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Helper (LocalStorage)</title>

    <script>
      (function() {
        const STORAGE_KEY_FONT_SIZE = 'aiPromptHelperFontSize';
        const DEFAULT_FONT_SIZE = 16;
        const MIN_FONT_SIZE = 10;
        const MAX_FONT_SIZE = 64;

        let sizeToApply = DEFAULT_FONT_SIZE;
        try {
          const savedSize = localStorage.getItem(STORAGE_KEY_FONT_SIZE);
          if (savedSize !== null) {
            const parsedSize = parseInt(savedSize, 10);
            if (!isNaN(parsedSize) && parsedSize >= MIN_FONT_SIZE && parsedSize <= MAX_FONT_SIZE) {
              sizeToApply = parsedSize;
            }
          }
        } catch (e) {
          console.error("Error reading font size from localStorage early:", e);
          // Use default size in case of error
        }
        // Apply font size to the root HTML element immediately
        document.documentElement.style.fontSize = sizeToApply + 'px';
      })();
    </script>
    <style>
    /* Basic Reset & Body */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html {
        height: 100%;
        /* Base font size set by inline script or this fallback */
        font-size: 16px; /* Default fallback */
    }
    body {
        font-family: sans-serif;
        display: flex;
        min-height: 100vh;
        /* Inherits font-size from html */
    }

    /* Sidebar */
    #sidebar {
        width: 250px;
        background-color: #f4f4f4;
        border-right: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        position: fixed; /* Fixed position */
        left: 0;
        top: 0;
        height: 100%; /* Full height */
        transform: translateX(-100%); /* Initially hidden */
        transition: transform 0.3s ease;
        z-index: 1000;
        padding-top: 45px; /* Space for toggle button placement within sidebar area */
        flex-shrink: 0; /* Prevent sidebar from shrinking */
    }
    body.sidebar-open #sidebar {
        transform: translateX(0);
    }
    /* -- Sidebar Toggle Button - Position adjusted slightly -- */
    #sidebar-toggle {
        position: fixed; /* Fixed position relative to viewport */
        top: 10px;       /* Adjusted top */
        left: 10px;       /* Adjusted left */
        z-index: 1001;
        background: #eee;
        border: 1px solid #ccc;
        padding: 5px 8px;
        cursor: pointer;
        font-size: 1.2em;
        transition: left 0.3s ease;
        border-radius: 3px;
    }
    body.sidebar-open #sidebar-toggle {
        left: 260px; /* Position toggle button next to open sidebar (250 + 10) */
     }

    #sidebar h2 {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #ccc;
        font-size: 1.1em; /* Relative size */
    }
    #sidebar-buttons {
        padding: 10px;
        border-bottom: 1px solid #ccc;
    }
    #sidebar-buttons button {
        display: block;
        width: 100%;
        padding: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        font-size: 0.9em; /* Relative size */
    }
    #prompt-list-container {
        flex-grow: 1;
        overflow-y: auto; /* Allow scrolling within prompt list if needed */
    }
    #prompt-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    #prompt-list li {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em; /* Relative size */
    }
    #prompt-list li:hover {
        background-color: #e9e9e9;
    }
    #prompt-list .delete-prompt {
        background: transparent;
        border: none;
        color: red;
        cursor: pointer;
        font-size: 1.2em; /* Slightly larger X */
        padding: 2px 5px;
        flex-shrink: 0; /* Prevent button from shrinking */
    }
     #prompt-list .prompt-name {
        flex-grow: 1;
        margin-right: 10px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }


    /* Main Content */
    #main-content {
        flex-grow: 1; /* Takes remaining space */
        padding: 55px 15px 15px 15px; /* Increased top padding */
        display: flex;
        flex-direction: column;
        height: 100vh; /* Make main content container viewport height */
        overflow-y: auto; /* Allow vertical scrolling WITHIN main content */
        transition: margin-left 0.3s ease, width 0.3s ease;
        width: 100%; /* Default width */
        margin-left: 0; /* Default margin */
    }
    body.sidebar-open #main-content {
        margin-left: 250px; /* Push main content */
        width: calc(100% - 250px); /* Adjust width when sidebar is open */
    }


    /* Sections within Main Content */
    #prompt-title {
        width: 100%;
        padding: 10px;
        font-size: 1.1em; /* Relative size */
        margin-bottom: 10px;
        border: 1px solid #ccc;
        flex-shrink: 0;
    }

    /* --- Font Size Controls --- */
    #font-controls {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 5px;
        background-color: #f8f8f8;
        border: 1px solid #eee;
        border-radius: 4px;
        flex-shrink: 0;
        flex-wrap: wrap; /* Allow wrapping on very small screens */
    }
    #font-controls span {
        margin-right: 10px;
        font-weight: bold;
        font-size: 0.9em; /* Relative size */
    }
    #font-controls button {
        padding: 3px 8px;
        font-size: 1.1em; /* Larger +/- */
        cursor: pointer;
        min-width: 30px;
        margin-left: 5px;
        border: 1px solid #ccc;
        background-color: #eee;
        border-radius: 3px;
        line-height: 1;
    }
     #font-controls button:hover {
         background-color: #ddd;
     }
     /* --- End Font Size Controls --- */


    #output-area {
        margin-bottom: 15px;
         flex-shrink: 0;
    }
    #output-area h2, #variables-area h2, #template-area h2 {
         margin-bottom: 5px;
         font-size: 1.0em; /* Relative size */
    }
    #output {
        width: 100%;
        height: 150px;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        resize: vertical;
        min-height: 75px;
        font-size: 0.9em; /* Relative size */
    }
    #copy-output {
        padding: 8px 15px;
        cursor: pointer;
        margin-top: 5px;
        font-size: 0.9em; /* Relative size */
    }

    #variables-area {
        margin-bottom: 15px;
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #fafafa;
         flex-shrink: 0;
    }
     #variables-area h2 { display: inline-block; margin-right: 10px; }
    #add-variable {
        padding: 3px 8px;
        font-size: 1.1em;
        cursor: pointer;
        margin-left: 10px;
        vertical-align: middle;
    }
    #variable-list {
        margin-top: 10px;
        max-height: 150px; /* Allow scrolling if many vars */
        overflow-y: auto;
        padding-right: 5px; /* Space for scrollbar */
    }
    .variable-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        padding: 5px;
        border: 1px solid #eee;
        background-color: #fff;
    }
    .variable-item label {
        font-weight: bold;
        margin-right: 10px;
        min-width: 20px; /* Ensure label alignment */
        text-align: center;
        font-size: 0.9em; /* Relative size */
    }
    .variable-item input {
        flex-grow: 1;
        padding: 5px;
        border: 1px solid #ccc;
        margin-right: 5px;
        min-width: 50px;
        font-size: 0.9em; /* Relative size */
    }
    .variable-item button {
        padding: 3px 6px;
        margin-left: 3px;
        cursor: pointer;
        line-height: 1;
        min-width: 25px;
        flex-shrink: 0;
        font-size: 0.8em; /* Smaller buttons */
    }
     .variable-item .var-delete { background-color: #ffdddd; }
     .variable-item .var-clear { background-color: #ffffcc; }
     .variable-item .var-paste { background-color: #ddeeff; }


    #template-area {
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* Takes remaining vertical space */
        margin-bottom: 15px;
        min-height: 150px;
        flex-shrink: 0;
    }
    #template {
        width: 100%;
        flex-grow: 1; /* Textarea grows vertically */
        padding: 10px;
        border: 1px solid #ccc;
        resize: vertical;
        margin-bottom: 5px;
        min-height: 100px;
        font-size: 0.9em; /* Relative size */
    }
    #variable-buttons {
         flex-shrink: 0;
    }
    #variable-buttons button {
        padding: 5px 10px;
        margin-right: 5px;
        margin-bottom: 5px; /* Allow wrapping */
        cursor: pointer;
        background-color: #e0e0e0;
        border: 1px solid #ccc;
        font-size: 0.9em; /* Relative size */
    }

    #action-buttons {
        padding-top: 10px;
        border-top: 1px solid #eee;
         flex-shrink: 0; /* Keep action buttons visible */
    }
    #action-buttons button {
        padding: 10px 20px;
        margin-right: 10px;
        cursor: pointer;
        font-size: 1em; /* Base relative size */
    }
     #save-prompt { background-color: #d4edda; border-color: #c3e6cb; }
     #duplicate-prompt { background-color: #cfe2ff; border-color: #b6d4fe; }

    /* Utility Classes */
    .hidden { display: none; }
    .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.5s ease;
        font-size: 0.9em; /* Relative size */
        max-width: 80%;
        text-align: center;
    }
    .toast.show {
        opacity: 1;
    }

    /* Simple responsive adjustments */
    @media (max-width: 600px) {
        /* Optional: Adjust sidebar width */
        /* #sidebar { width: 200px; } */
        /* body.sidebar-open #main-content { margin-left: 200px; width: calc(100% - 200px); } */
        /* body.sidebar-open #sidebar-toggle { left: 210px; } */

         .variable-item button {
             padding: 2px 4px;
             min-width: 22px;
             font-size: 0.75em; /* Even smaller on mobile */
         }
         .variable-item input {
             padding: 4px;
         }
          #action-buttons button {
             padding: 8px 15px;
             font-size: 0.9em; /* Relative size */
         }
         #output { height: 120px; min-height: 60px;}
         #template { min-height: 80px; }
         #main-content { padding: 55px 10px 10px 10px; } /* Less horizontal padding */

         #font-controls {
            padding: 3px;
         }
         #font-controls span {
             margin-right: 5px; /* Less space on mobile */
             margin-bottom: 3px; /* Allow wrap spacing */
         }
         #font-controls button {
             padding: 2px 6px;
             font-size: 1em; /* Adjust if needed */
             margin-left: 3px;
             margin-bottom: 3px; /* Allow wrap spacing */
         }
    }

</style>
</head>
<body>

    <button id="sidebar-toggle" title="Toggle Sidebar">&#9776;</button>
    <div id="sidebar">
        <h2>Prompts</h2>
        <div id="sidebar-buttons">
            <button id="new-prompt">New Prompt</button>
        </div>
        <div id="prompt-list-container">
            <ul id="prompt-list">
                </ul>
        </div>
    </div>

    <div id="main-content">
        <input type="text" id="prompt-title" placeholder="Enter Prompt Title Here...">

        <div id="font-controls">
            <span>Font Size:</span>
            <button id="font-decrease" title="Decrease Font Size">-</button>
            <button id="font-increase" title="Increase Font Size">+</button>
        </div>
        <div id="output-area">
             <h2>Output</h2>
            <textarea id="output" readonly placeholder="Template output with variables replaced will appear here..."></textarea>
            <button id="copy-output">Copy Output</button>
        </div>

        <div id="variables-area">
            <h2>Variables</h2>
            <button id="add-variable" title="Add Variable">+</button>
            <div id="variable-list">
                </div>
        </div>

        <div id="template-area">
             <h2>Template</h2>
            <textarea id="template" placeholder="Enter your template text here. Use buttons below or type __var__ to insert variable placeholders."></textarea>
            <div id="variable-buttons">
                </div>
        </div>

        <div id="action-buttons">
            <button id="save-prompt">Save</button>
            <button id="duplicate-prompt">Duplicate</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // --- DOM Elements ---
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mainContent = document.getElementById('main-content');
        const newPromptBtn = document.getElementById('new-prompt');
        const promptListUl = document.getElementById('prompt-list');
        const promptTitleInput = document.getElementById('prompt-title');
        const fontControlsContainer = document.getElementById('font-controls');
        const fontIncreaseBtn = document.getElementById('font-increase');
        const fontDecreaseBtn = document.getElementById('font-decrease');
        const outputTextarea = document.getElementById('output');
        const copyOutputBtn = document.getElementById('copy-output');
        const addVariableBtn = document.getElementById('add-variable');
        const variableListDiv = document.getElementById('variable-list');
        const templateTextarea = document.getElementById('template');
        const variableButtonsDiv = document.getElementById('variable-buttons');
        const savePromptBtn = document.getElementById('save-prompt');
        const duplicatePromptBtn = document.getElementById('duplicate-prompt');
        const toastDiv = document.getElementById('toast');
        const rootElement = document.documentElement; // Target for font size

        // --- Constants ---
        const STORAGE_KEY_PROMPTS = 'aiPromptHelperPrompts';
        const STORAGE_KEY_FONT_SIZE = 'aiPromptHelperFontSize'; // Key used by head script too
        const DEFAULT_FONT_SIZE = 16; // Default if nothing saved
        const MIN_FONT_SIZE = 10;
        const MAX_FONT_SIZE = 64;
        const FONT_SIZE_STEP = 1;

        // --- State ---
        let currentPrompt = {
            id: '', title: '', variables: {}, template: ''
        };
        let savedPrompts = {};
        let currentFontSize = DEFAULT_FONT_SIZE; // Initialized properly in loadFontSizePreference

        // --- Functions ---

        function showToast(message) {
            toastDiv.textContent = message;
            toastDiv.classList.add('show');
            setTimeout(() => {
                toastDiv.classList.remove('show');
            }, 2000);
        }

        // --- LocalStorage Utilities ---
        function setLocalStorageItem(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error(`Error saving to localStorage (key: ${key}):`, e);
                if (e.name === 'QuotaExceededError') {
                    showToast("Error: Storage space is full. Could not save data.");
                } else {
                    showToast("Error: Could not save data to local storage.");
                }
            }
        }

        function getLocalStorageItem(key) {
            const item = localStorage.getItem(key);
            if (item === null) return null;
            try {
                return JSON.parse(item);
            } catch (e) {
                console.error(`Error parsing localStorage item (key: ${key}):`, e);
                return null;
            }
        }

        function removeLocalStorageItem(key) {
            localStorage.removeItem(key);
        }

        // --- Font Size Management ---
        function applyFontSize(size) {
            const newSize = Math.max(MIN_FONT_SIZE, Math.min(MAX_FONT_SIZE, size));
            // Update internal state variable IF it changed
             if (currentFontSize !== newSize) {
                 currentFontSize = newSize;
             }

             // Apply style (might be redundant on initial load, but needed for +/- clicks)
             rootElement.style.fontSize = `${newSize}px`;

             // Update button states
             fontDecreaseBtn.disabled = newSize <= MIN_FONT_SIZE;
             fontIncreaseBtn.disabled = newSize >= MAX_FONT_SIZE;

             // Save preference only if called via button clicks (will be called from increase/decrease)
             // saveFontSizePreference(newSize); // -> Moved saving into increase/decrease
        }

        function increaseFontSize() {
            const newSize = Math.min(MAX_FONT_SIZE, currentFontSize + FONT_SIZE_STEP);
             if (newSize !== currentFontSize) {
                 applyFontSize(newSize); // Applies style and updates state
                 saveFontSizePreference(newSize); // Save the new preference
             }
        }

        function decreaseFontSize() {
            const newSize = Math.max(MIN_FONT_SIZE, currentFontSize - FONT_SIZE_STEP);
            if (newSize !== currentFontSize) {
                applyFontSize(newSize); // Applies style and updates state
                saveFontSizePreference(newSize); // Save the new preference
            }
        }

        function saveFontSizePreference(size) {
            localStorage.setItem(STORAGE_KEY_FONT_SIZE, size); // Save validated size
        }

        function loadFontSizePreference() {
            // Read the value again to initialize the *state variable* and button states
            // The initial *visual style* was set by the head script.
             const savedSize = localStorage.getItem(STORAGE_KEY_FONT_SIZE);
             let initialSize = DEFAULT_FONT_SIZE;
             if (savedSize !== null) {
                 const parsedSize = parseInt(savedSize, 10);
                 if (!isNaN(parsedSize) && parsedSize >= MIN_FONT_SIZE && parsedSize <= MAX_FONT_SIZE) {
                     initialSize = parsedSize;
                 }
             }
             // Set the internal state and button disabled states correctly
             currentFontSize = initialSize; // Ensure state matches loaded value
             applyFontSize(initialSize); // Apply to set buttons correctly
        }
        // --- End Font Size Management ---


        // --- Prompt Loading/Saving (Using LocalStorage) ---

        function loadPromptsFromStorage() {
            savedPrompts = getLocalStorageItem(STORAGE_KEY_PROMPTS) || {};
            renderPromptList();
        }

        function savePromptsToStorage() {
            setLocalStorageItem(STORAGE_KEY_PROMPTS, savedPrompts);
        }

        function saveCurrentPrompt() {
            const title = promptTitleInput.value.trim();
            if (!title) {
                showToast("Please enter a title before saving.");
                return;
            }
            currentPrompt.title = title;
            let idToSave = currentPrompt.id;
            if (!idToSave) {
                idToSave = 'prompt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                currentPrompt.id = idToSave;
            }
            savedPrompts[idToSave] = JSON.parse(JSON.stringify(currentPrompt));
            savePromptsToStorage();
            renderPromptList();
             const listItem = promptListUl.querySelector(`li[data-id="${idToSave}"]`);
             if(listItem) {
                 listItem.style.backgroundColor = '#d4edda';
                 setTimeout(() => { listItem.style.backgroundColor = ''; }, 1000);
             }
            showToast(`Prompt "${currentPrompt.title}" saved!`);
        }

        function loadPrompt(promptId) {
            if (!savedPrompts[promptId]) {
                console.error("Prompt ID not found:", promptId);
                showToast("Error: Could not load prompt.");
                return;
            }
            currentPrompt = JSON.parse(JSON.stringify(savedPrompts[promptId]));
            promptTitleInput.value = currentPrompt.title;
            templateTextarea.value = currentPrompt.template;
            variableListDiv.innerHTML = '';
            variableButtonsDiv.innerHTML = '';
            Object.keys(currentPrompt.variables).sort().forEach(varName => {
                addVariableElement(varName, currentPrompt.variables[varName]);
            });
            updateOutput();
            closeSidebar();
            showToast(`Prompt "${currentPrompt.title}" loaded.`);
        }

        function deletePrompt(promptId, promptTitle) {
             if (!confirm(`Are you sure you want to delete the prompt "${promptTitle}"?`)) return;
            if (savedPrompts[promptId]) {
                delete savedPrompts[promptId];
                savePromptsToStorage();
                renderPromptList();
                if (currentPrompt.id === promptId) createNewPromptState();
                showToast(`Prompt "${promptTitle}" deleted.`);
            } else {
                showToast("Error: Could not delete prompt.");
            }
        }

        function createNewPromptState() {
            currentPrompt = { id: '', title: '', variables: {}, template: '' };
            promptTitleInput.value = '';
            templateTextarea.value = '';
            variableListDiv.innerHTML = '';
            variableButtonsDiv.innerHTML = '';
            outputTextarea.value = '';
            promptTitleInput.focus();
            closeSidebar();
            if (Object.keys(savedPrompts).length > 0 || document.readyState === "complete") {
                showToast("New prompt created.");
            }
        }

        function duplicateCurrentPrompt() {
            const newPrompt = JSON.parse(JSON.stringify(currentPrompt));
            newPrompt.id = '';
            newPrompt.title = currentPrompt.title + " (Copy)";
            currentPrompt = newPrompt;
            promptTitleInput.value = currentPrompt.title;
            templateTextarea.value = currentPrompt.template;
            variableListDiv.innerHTML = '';
            variableButtonsDiv.innerHTML = '';
            Object.keys(currentPrompt.variables).sort().forEach(varName => {
                 addVariableElement(varName, currentPrompt.variables[varName]);
            });
            updateOutput();
            showToast("Prompt duplicated. Remember to Save.");
        }

        // --- Sidebar ---
        function toggleSidebar() {
            document.body.classList.toggle('sidebar-open');
        }
         function closeSidebar() {
             document.body.classList.remove('sidebar-open');
         }

        function renderPromptList() {
            promptListUl.innerHTML = '';
            const sortedIds = Object.keys(savedPrompts).sort((a, b) => {
                 const titleA = (savedPrompts[a].title || '').toLowerCase();
                 const titleB = (savedPrompts[b].title || '').toLowerCase();
                 if (titleA < titleB) return -1;
                 if (titleA > titleB) return 1;
                 return 0;
            });

            if (sortedIds.length === 0) {
                 promptListUl.innerHTML = '<li style="color: grey; text-align: center; padding: 20px; font-style: italic;">No saved prompts</li>';
                 return;
            }

            sortedIds.forEach(id => {
                const prompt = savedPrompts[id];
                const li = document.createElement('li');
                li.setAttribute('data-id', id);
                const nameSpan = document.createElement('span');
                nameSpan.classList.add('prompt-name');
                nameSpan.textContent = prompt.title || '(Untitled)';
                nameSpan.title = prompt.title || '(Untitled)';
                nameSpan.onclick = (event) => { if (event.target === nameSpan) loadPrompt(id); };
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Ã—';
                deleteBtn.classList.add('delete-prompt');
                deleteBtn.title = 'Delete Prompt';
                deleteBtn.onclick = (event) => { event.stopPropagation(); deletePrompt(id, prompt.title); };
                li.appendChild(nameSpan);
                li.appendChild(deleteBtn);
                promptListUl.appendChild(li);
            });
        }

        // --- Variable Management --- (No changes needed here)
        function getNextVarName(){const e=Object.keys(currentPrompt.variables);for(let t=0;t<26;t++){const n=String.fromCharCode(97+t);if(!e.includes(n))return n}return showToast("Maximum variables (z) reached."),null}
        function addVariableElement(e,t=""){e in currentPrompt.variables||(currentPrompt.variables[e]=t);const n=document.createElement("div");n.classList.add("variable-item"),n.setAttribute("data-varname",e);const o=document.createElement("label");o.textContent=e;const a=document.createElement("input");a.type="text",a.value=t,a.placeholder=`Value for "${e}"`,a.oninput=()=>{currentPrompt.variables[e]=a.value,updateOutput()},a.onpaste=()=>{setTimeout(()=>{a.dispatchEvent(new Event("input"))},0)};const r=document.createElement("button");r.textContent="Clr",r.title="Clear Value",r.classList.add("var-clear"),r.onclick=()=>{a.value="",a.dispatchEvent(new Event("input"))};const s=document.createElement("button");s.textContent="Pst",s.title="Paste from Clipboard",s.classList.add("var-paste"),s.onclick=async()=>{try{const e=await navigator.clipboard.readText();a.value=e,a.dispatchEvent(new Event("input")),showToast(`Pasted into variable "${e}".`)}catch(e){console.error("Failed to read clipboard contents: ",e),showToast("Failed to paste. Check permissions.")}};const l=document.createElement("button");l.textContent="Del",l.title="Delete Variable",l.classList.add("var-delete"),l.onclick=()=>{removeVariable(e)},n.appendChild(o),n.appendChild(a),n.appendChild(r),n.appendChild(s),n.appendChild(l),variableListDiv.appendChild(n),addVariableInsertButton(e),updateOutput()}
        function handleAddVariableClick(){const e=getNextVarName();if(e){addVariableElement(e);const t=variableListDiv.querySelector(`[data-varname="${e}"] input`);t&&t.focus()}}
        function removeVariable(e){delete currentPrompt.variables[e];const t=variableListDiv.querySelector(`.variable-item[data-varname="${e}"]`);t&&t.remove();const n=variableButtonsDiv.querySelector(`button[data-varname="${e}"]`);n&&n.remove(),updateOutput()}
        function addVariableInsertButton(e){const t=document.createElement("button");t.textContent=e,t.title=`Insert __${e}__`,t.setAttribute("data-varname",e),t.onclick=()=>{insertTextAtCursor(templateTextarea,`__${e}__`),templateTextarea.dispatchEvent(new Event("input",{bubbles:!0}))},variableButtonsDiv.appendChild(t)}
        function insertTextAtCursor(e,t){const n=e.selectionStart,o=e.selectionEnd,a=e.value;e.value=a.substring(0,n)+t+a.substring(o),e.selectionStart=e.selectionEnd=n+t.length,e.focus()}

        // --- Output Generation --- (Unchanged)
        function updateOutput(){let e=currentPrompt.template;const t=Object.keys(currentPrompt.variables).sort(((e,t)=>t.length-e.length));t.forEach((t=>{const n=`__${t}__`,o=new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g");e=e.replace(o,currentPrompt.variables[t]||"")})),outputTextarea.value=e}

        // --- Event Listeners ---
        sidebarToggle.addEventListener('click', toggleSidebar);
        newPromptBtn.addEventListener('click', createNewPromptState);
        savePromptBtn.addEventListener('click', saveCurrentPrompt);
        duplicatePromptBtn.addEventListener('click', duplicateCurrentPrompt);
        addVariableBtn.addEventListener('click', handleAddVariableClick);
        fontIncreaseBtn.addEventListener('click', increaseFontSize);
        fontDecreaseBtn.addEventListener('click', decreaseFontSize);
        templateTextarea.addEventListener('input', () => { currentPrompt.template = templateTextarea.value; updateOutput(); });
        promptTitleInput.addEventListener('input', () => { if (currentPrompt.id) currentPrompt.title = promptTitleInput.value; });
        copyOutputBtn.addEventListener('click', async () => {
            if (!outputTextarea.value) { showToast("Output is empty."); return; }
            try { await navigator.clipboard.writeText(outputTextarea.value); showToast("Output copied to clipboard!"); }
            catch (err) { console.error('Failed to copy text: ', err); showToast("Failed to copy. Check permissions."); }
        });
        document.addEventListener('click', (event) => {
            if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target) && document.body.classList.contains('sidebar-open')) { closeSidebar(); }
        });

        // --- Initialization ---
        function initialize() {
            loadFontSizePreference(); // Load font size state & set buttons
            loadPromptsFromStorage(); // Load prompts
             const promptIds = Object.keys(savedPrompts);
             if(promptIds.length > 0) {
                 loadPrompt(promptIds[0]); // Load first prompt
             } else {
                createNewPromptState(); // Start blank
                showToast("Welcome! Create a new prompt or load one.");
             }
             closeSidebar(); // Start closed
        }

        // Wait for the DOM to be ready for the main script logic
        document.addEventListener('DOMContentLoaded', initialize);

    </script>

</body>
</html>